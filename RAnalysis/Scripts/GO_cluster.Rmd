---
title: "GO Clusters"
author: "Shelly Trigg"
date: "5/11/2020"
output: html_document
---

load libraries
```{r}
library(data.table)
library(gplots)
library(dplyr)
library(RColorBrewer)
library(ontologySimilarity)
library(ontologyIndex)
library(plotrix)
```

## Part 1: Generate BP Semantic Similarity heatmaps for Day 10, Day 135, and Day 145 pH group comparisons

read BP data
```{r}
BP_Sig_D10 <- fread("https://raw.githubusercontent.com/hputnam/Geoduck_Meth/master/RAnalysis/Output/BP_Sig_Enriched_GO.05_D10.csv",stringsAsFactors = F, header = T)

BP_Sig_D135 <- fread("https://raw.githubusercontent.com/hputnam/Geoduck_Meth/master/RAnalysis/Output/BP_Sig_Enriched_GO.05_D135.csv",stringsAsFactors = F, header = T)

BP_Sig_D145 <- fread("https://raw.githubusercontent.com/hputnam/Geoduck_Meth/master/RAnalysis/Output/BP_Sig_Enriched_GO.05_D145.csv",stringsAsFactors = F, header = T)
```

**GO SEMSIM OF ENRICHED GENES**
```{r}
#load GO data and GO info from OntologyIndex package
data(go)
data(GO_IC)

#create a list of character vectors called terms from enriched GO IDs

BP_Sig_D10_terms <- as.list(BP_Sig_D10$category)

BP_Sig_D135_terms <- as.list(BP_Sig_D135$category)

BP_Sig_D145_terms <- as.list(BP_Sig_D145$category)

#Get GO info in ontologyX database (GO.obo) for terms in "terms" list. This may exclude some GO IDs if they are not present in the GO data from ontologyIndex package
BP_Sig_D10_GO_IC_data <- get_term_info_content(go, term_sets = as.vector(BP_Sig_D10$category))

BP_Sig_D135_GO_IC_data <- get_term_info_content(go, term_sets = as.vector(BP_Sig_D135$category))

BP_Sig_D145_GO_IC_data <- get_term_info_content(go, term_sets = as.vector(BP_Sig_D145$category))

#Subset terms to match the GO info extracted from the GO data from ontologyIndex package; this will remove terms that were not present in the GO data from ontologyIndex package 
BP_Sig_D10_terms <- BP_Sig_D10_terms[BP_Sig_D10_terms %in% names(BP_Sig_D10_GO_IC_data)]

BP_Sig_D135_terms <- BP_Sig_D135_terms[BP_Sig_D135_terms %in% names(BP_Sig_D135_GO_IC_data)]

BP_Sig_D145_terms <- BP_Sig_D145_terms[BP_Sig_D145_terms %in% names(BP_Sig_D145_GO_IC_data)]


#create a semantic similarity matrix with enriched GO IDs
BP_Sig_D10_sim_matrix <- get_sim_grid(ontology=go,information_content=BP_Sig_D10_GO_IC_data,term_sets=BP_Sig_D10_terms)

BP_Sig_D135_sim_matrix <- get_sim_grid(ontology=go,information_content=BP_Sig_D135_GO_IC_data,term_sets=BP_Sig_D135_terms)

BP_Sig_D145_sim_matrix <- get_sim_grid(ontology=go,information_content=BP_Sig_D145_GO_IC_data,term_sets=BP_Sig_D145_terms)

#create a data frame with GO IDs and terms for each matrix; these will be the row names

BP_Sig_D10_sim_matrix_names <- BP_Sig_D10[which(BP_Sig_D10$category %in% BP_Sig_D10_terms),c("category", "name")]

BP_Sig_D135_sim_matrix_names <- BP_Sig_D135[which(BP_Sig_D135$category %in% BP_Sig_D135_terms),c("category", "name")]

BP_Sig_D145_sim_matrix_names <- BP_Sig_D145[which(BP_Sig_D145$category %in% BP_Sig_D145_terms),c("category", "name")]

#create a column with the GO ID and the term in one string separated by a colon
BP_Sig_D10_sim_matrix_names$cat_name <- paste(BP_Sig_D10_sim_matrix_names$category, BP_Sig_D10_sim_matrix_names$name, sep = ": ")

BP_Sig_D135_sim_matrix_names$cat_name <- paste(BP_Sig_D135_sim_matrix_names$category, BP_Sig_D135_sim_matrix_names$name, sep = ": ")

BP_Sig_D145_sim_matrix_names$cat_name <- paste(BP_Sig_D145_sim_matrix_names$category, BP_Sig_D145_sim_matrix_names$name, sep = ": ")


#add row and column names to similarity matrix
rownames(BP_Sig_D10_sim_matrix) <- BP_Sig_D10_sim_matrix_names$cat_name

colnames(BP_Sig_D10_sim_matrix) <- unlist(BP_Sig_D10_terms)
  
rownames(BP_Sig_D135_sim_matrix) <- BP_Sig_D135_sim_matrix_names$cat_name

colnames(BP_Sig_D135_sim_matrix) <- unlist(BP_Sig_D135_terms)

rownames(BP_Sig_D145_sim_matrix) <- BP_Sig_D145_sim_matrix_names$cat_name

colnames(BP_Sig_D145_sim_matrix) <- unlist(BP_Sig_D145_terms)
```

**Generate heatmaps of semantic similarities**
```{r}
#define breaks so there will be 5 colors for the following ranges of semantic similarity scores:  0-0.2, 0.2-0.4, 0.4-0.6, 0.6-0.8, and 0.8-1.0
breaks <- c(seq(0,1, length=6))

#Save Day 10 BP heatmap
jpeg(file="../Output/GOsemsim_heatmap_D10_BP_sig_GO.jpg", width=10, height=6, units = "in", res = 300)
heatmap.2(BP_Sig_D10_sim_matrix, margins = c(5,20), cexRow = 0.3,distfun = function(x) as.dist(1 - cor(t(x), use = "pa")), hclustfun = function(x) hclust(x,method = 'average'), labRow = rownames(BP_Sig_D10_sim_matrix),labCol = FALSE,col= rev(colorRampPalette(brewer.pal(5, "RdYlBu"))(5)), density.info = "none", trace = "none")
dev.off()

#Save Day 135 BP heatmap
jpeg(file="../Output/GOsemsim_heatmap_D135_BP_sig_GO.jpg", width=10, height=6, units = "in", res = 300)
heatmap.2(BP_Sig_D135_sim_matrix, margins = c(5,20), cexRow = 0.3,distfun = function(x) as.dist(1 - cor(t(x), use = "pa")), hclustfun = function(x) hclust(x,method = 'average'), labRow = rownames(BP_Sig_D135_sim_matrix),labCol = FALSE,col= rev(colorRampPalette(brewer.pal(5, "RdYlBu"))(5)), density.info = "none", trace = "none")
dev.off()

#Save Day 145 BP heatmap
jpeg(file="../Output/GOsemsim_heatmap_D145_BP_sig_GO.jpg", width=10, height=6, units = "in", res = 300)
heatmap.2(BP_Sig_D145_sim_matrix, margins = c(5,20), cexRow = 0.3,distfun = function(x) as.dist(1 - cor(t(x), use = "pa")), hclustfun = function(x) hclust(x,method = 'average'), labRow = rownames(BP_Sig_D145_sim_matrix),labCol = FALSE,col= rev(colorRampPalette(brewer.pal(5, "RdYlBu"))(5)), density.info = "none", trace = "none")
dev.off()
```

## Part 2: Generate MF Semantic Similarity heatmaps for Day 10, Day 135, and Day 145 pH group comparisons

read MF data
```{r}
MF_Sig_D10 <- fread("https://raw.githubusercontent.com/hputnam/Geoduck_Meth/master/RAnalysis/Output/MF_Sig_Enriched_GO.05_D10.csv",stringsAsFactors = F, header = T)

MF_Sig_D135 <- fread("https://raw.githubusercontent.com/hputnam/Geoduck_Meth/master/RAnalysis/Output/MF_Sig_Enriched_GO.05_D135.csv",stringsAsFactors = F, header = T)

MF_Sig_D145 <- fread("https://raw.githubusercontent.com/hputnam/Geoduck_Meth/master/RAnalysis/Output/MF_Sig_Enriched_GO.05_D145.csv",stringsAsFactors = F, header = T)
```

**GO SEMSIM OF ENRICHED GENES**
```{r}
#load GO data and GO info from OntologyIndex package
data(go)
data(GO_IC)

#create a list of character vectors called terms from enriched GO IDs

MF_Sig_D10_terms <- as.list(MF_Sig_D10$category)

MF_Sig_D135_terms <- as.list(MF_Sig_D135$category)

MF_Sig_D145_terms <- as.list(MF_Sig_D145$category)

#Get GO info in ontologyX database (GO.obo) for terms in "terms" list. This may exclude some GO IDs if they are not present in the GO data from ontologyIndex package
MF_Sig_D10_GO_IC_data <- get_term_info_content(go, term_sets = as.vector(MF_Sig_D10$category))

MF_Sig_D135_GO_IC_data <- get_term_info_content(go, term_sets = as.vector(MF_Sig_D135$category))

MF_Sig_D145_GO_IC_data <- get_term_info_content(go, term_sets = as.vector(MF_Sig_D145$category))

#Subset terms to match the GO info extracted from the GO data from ontologyIndex package; this will remove terms that were not present in the GO data from ontologyIndex package 
MF_Sig_D10_terms <- MF_Sig_D10_terms[MF_Sig_D10_terms %in% names(MF_Sig_D10_GO_IC_data)]

MF_Sig_D135_terms <- MF_Sig_D135_terms[MF_Sig_D135_terms %in% names(MF_Sig_D135_GO_IC_data)]

MF_Sig_D145_terms <- MF_Sig_D145_terms[MF_Sig_D145_terms %in% names(MF_Sig_D145_GO_IC_data)]


#create a semantic similarity matrix with enriched GO IDs
MF_Sig_D10_sim_matrix <- get_sim_grid(ontology=go,information_content=MF_Sig_D10_GO_IC_data,term_sets=MF_Sig_D10_terms)

MF_Sig_D135_sim_matrix <- get_sim_grid(ontology=go,information_content=MF_Sig_D135_GO_IC_data,term_sets=MF_Sig_D135_terms)

MF_Sig_D145_sim_matrix <- get_sim_grid(ontology=go,information_content=MF_Sig_D145_GO_IC_data,term_sets=MF_Sig_D145_terms)

#create a data frame with GO IDs and terms for each matrix; these will be the row names

MF_Sig_D10_sim_matrix_names <- MF_Sig_D10[which(MF_Sig_D10$category %in% MF_Sig_D10_terms),c("category", "name")]

MF_Sig_D135_sim_matrix_names <- MF_Sig_D135[which(MF_Sig_D135$category %in% MF_Sig_D135_terms),c("category", "name")]

MF_Sig_D145_sim_matrix_names <- MF_Sig_D145[which(MF_Sig_D145$category %in% MF_Sig_D145_terms),c("category", "name")]

#create a column with the GO ID and the term in one string separated by a colon
MF_Sig_D10_sim_matrix_names$cat_name <- paste(MF_Sig_D10_sim_matrix_names$category, MF_Sig_D10_sim_matrix_names$name, sep = ": ")

MF_Sig_D135_sim_matrix_names$cat_name <- paste(MF_Sig_D135_sim_matrix_names$category, MF_Sig_D135_sim_matrix_names$name, sep = ": ")

MF_Sig_D145_sim_matrix_names$cat_name <- paste(MF_Sig_D145_sim_matrix_names$category, MF_Sig_D145_sim_matrix_names$name, sep = ": ")


#add row and column names to similarity matrix
rownames(MF_Sig_D10_sim_matrix) <- MF_Sig_D10_sim_matrix_names$cat_name

colnames(MF_Sig_D10_sim_matrix) <- unlist(MF_Sig_D10_terms)
  
rownames(MF_Sig_D135_sim_matrix) <- MF_Sig_D135_sim_matrix_names$cat_name

colnames(MF_Sig_D135_sim_matrix) <- unlist(MF_Sig_D135_terms)

rownames(MF_Sig_D145_sim_matrix) <- MF_Sig_D145_sim_matrix_names$cat_name

colnames(MF_Sig_D145_sim_matrix) <- unlist(MF_Sig_D145_terms)

```

**Generate heatmaps of semantic similarities**
```{r}
#define breaks so there will be 5 colors for the following ranges of semantic similarity scores:  0-0.2, 0.2-0.4, 0.4-0.6, 0.6-0.8, and 0.8-1.0

breaks <- c(seq(0,1, length=6))

#Save Day 10 MF heatmap
jpeg(file="../Output/GOsemsim_heatmap_D10_MF_sig_GO.jpg", width=10, height=6, units = "in", res = 300)
heatmap.2(MF_Sig_D10_sim_matrix, margins = c(5,20), cexRow = 0.5,distfun = function(x) as.dist(1 - cor(t(x), use = "pa")), hclustfun = function(x) hclust(x,method = 'average'), labRow = rownames(MF_Sig_D10_sim_matrix),labCol = FALSE,col= rev(colorRampPalette(brewer.pal(5, "RdYlBu"))(5)), density.info = "none", trace = "none")
dev.off()

#Save Day 135 MF heatmap
jpeg(file="../Output/GOsemsim_heatmap_D135_MF_sig_GO.jpg", width=10, height=6, units = "in", res = 300)
heatmap.2(MF_Sig_D135_sim_matrix, margins = c(5,20), cexRow = 0.3,distfun = function(x) as.dist(1 - cor(t(x), use = "pa")), hclustfun = function(x) hclust(x,method = 'average'), labRow = rownames(MF_Sig_D135_sim_matrix),labCol = FALSE,col= rev(colorRampPalette(brewer.pal(5, "RdYlBu"))(5)), density.info = "none", trace = "none")
dev.off()

#Save Day 145 MF heatmap
jpeg(file="../Output/GOsemsim_heatmap_D145_MF_sig_GO.jpg", width=10, height=6, units = "in", res = 300)
heatmap.2(MF_Sig_D145_sim_matrix, margins = c(5,20), cexRow = 0.5,distfun = function(x) as.dist(1 - cor(t(x), use = "pa")), hclustfun = function(x) hclust(x,method = 'average'), labRow = rownames(MF_Sig_D145_sim_matrix),labCol = FALSE,col= rev(colorRampPalette(brewer.pal(5, "RdYlBu"))(5)), density.info = "none", trace = "none")
dev.off()
```


Below I was messing around with assigning color IDs to different clusters of GO terms. 

```{r}
#generate distance matrix
hm <- as.dist(1-cor(BP_Sig_D10_sim_matrix, use="pa"))
#generate dendrogram from distance matrix using average clustering
hm2 <- hclust(hm, method = 'average')
#plot clustered dendrogram
plot(hm2, cex = 0.3)
#draw a line at dendrogram threshold; 0.3 was an arbitrary cutoff
abline(h=0.3, col = "red")

#cut the dendrogram at the threshold and save it as a new object 
mycl <- cutree(hm2, h=0.3)

#assign colors to clusters
clusterCols <- colorRamps::primary.colors(length(unique(mycl)))
myClusterSideBar <- clusterCols[mycl]

#add cluster colors to heatmap

jpeg(file="../Output/GOsemsim_ClustColor_heatmap_D10_BP_sig_GO.jpg", width=10, height=6, units = "in", res = 300)
heatmap.2(BP_Sig_D10_sim_matrix, margins = c(5,20), cexRow = 0.3,distfun = function(x) as.dist(1 - cor(t(x), use = "pa")), hclustfun = function(x) hclust(x,method = 'average'), labRow = rownames(BP_Sig_D10_sim_matrix),labCol = FALSE,col= rev(colorRampPalette(brewer.pal(5, "RdYlBu"))(5)), density.info = "none", trace = "none", RowSideColors =myClusterSideBar )
dev.off()


#get cluster color IDs
clusterColor <- lapply(myClusterSideBar, color.id)
clusterColor <- lapply(clusterColor, `[[`,1)
clusterColor <- data.frame(unlist(clusterColor), stringsAsFactors = FALSE)

#create data frame with cluster ID number and cluster color ID
GO_clust <- cbind(data.frame(mycl), clusterColor)
#add GO ID column to data frame for merging
GO_clust$GO <- rownames(GO_clust)
colnames(GO_clust) <- c("clust.num","clust.color","category")

#merge cluster IDs with term info
D10_GO_clust <- (merge(GO_clust, BP_Sig_D10, by = "category"))
```
